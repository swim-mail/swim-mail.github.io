const MAX_desktop=40,MAX_mobile=30,ENLIST_DAY=new Date("2021-02-15"),COMPLETION_DAY=new Date("2021-03-19"),DISCHARGE_DAY=new Date("2022-11-14"),PRECISION=5,DEFAULT_THROTTLE=500,API_PATH="https://asia-northeast3-swim-mail.cloudfunctions.net/",API_TIMEOUT=10,NOW_INTERVAL=10,FORCE_UPDATE_INTERVAL=1;class Animator{constructor(t){this.break=null,this.throttle=t||500}register(t){this.f=e=>{this.break||(e-this.starttime>this.throttle&&(this.starttime=e,t()),window.requestAnimationFrame(this.f))}}start(){this.break=null,this.starttime=performance.now(),window.requestAnimationFrame(this.f)}stop(){this.break=!0}}class PaperGraph extends HTMLElement{constructor(){super()}static get observedAttributes(){return["value","today","max"]}connectedCallback(){this.start()}attributeChangedCallback(t,e,a){this[t]=a,this.start()}update(t,e){this.today==t&&this.value==e||(this.today=t,this.value=e,this.start())}error(){this.start(!0)}start(t){t&&(this.today=10,this.value=30),window.matchMedia("(min-width: 900px)").matches||(this.max=30);const e=`<style>\n      paper-graph{\n        height:${Math.min(37,1*this.value+Math.max(0,22-this.value)/3)}vw\n      }\n      .tdfig{\n        height:${Math.min(this.max-10,Math.max(this.today,10)),(10-this.total+this.today)/10*this.max}vw\n      }\n    @media (max-width: 900px) {\n      paper-graph{\n      min-height:15vw;\n      height:${Math.min(55,10+1.5*Math.min(this.value,this.max))}vw;\n      margin-bottom:3em;\n      }\n      .tdfig{\n        height:${Math.min(this.max+10,Math.max(1.5*this.today,15)),(10-this.total+this.today)/10*this.max}vw\n      }\n    }\n    </style>\n`,a=Math.min(this.value,this.max);let s=.1,r=`<use xlink:href=${this.today<=0?"#letter":"#letterH"} opacity="0">\n      <animate attributeName="opacity" from="0" to="1" begin="${s*Math.log2(a)/.8}" dur="0.1s" fill="freeze"/>\n      </use>`;for(let t=0;t<a-1;t++)r+=`<use xlink:href="${t>this.today-2?"#stack":"#stackH"}"  y="${35+13*t}" opacity="0">\n         <animate attributeName="opacity" from="0" to="1" begin="${s*Math.log2(a-t)*.9**t}" dur="0.1s" fill="freeze"  />\n        </use>`;if(this.value<12){this.istoday=(new Date).getHours()<17?"오늘":"내일";var n=`\n      <div class="tdfig">\n      <span>${this.istoday} 갈 / 총 편지</span><br>\n      <span class="big">${t?"?":this.today}</span><span>/${t?"?":this.value}개</span>\n      </div>\n      `}else n=`\n      <div class="tdfig tcd">\n      <span>${this.istoday} 전달</span><span class='mbhide'>될 편지</span><br>\n      <count-up value="${t?"?":this.today}" dur="1.2" class="big">${t?"?":""}</count-up><span class="faded">개</span>\n      </div>\n\n      <div class="ttfig">\n      <span>총</span><span class='mbhide'> 쓰여진 편지</span><br>\n      <count-up value="${t?"?":this.value}" dur="1.2" class="big">${t?"?":""}</count-up><span>개</span>\n      </div>\n      `;this.innerHTML=e+'<svg viewbox="0 0 100 70" preserveAspectRatio="xMidYMin meet">\n                <symbol id="letter" viewbox="-10 0 120 60">\n            <polygon class=\'graph\' points="0,30 50,60 100,30 50,0 0,30"/>\n          </symbol>\n          <symbol id="letterH" viewbox="-10 0 120 60">\n          <polygon class=\'graph\' points="0,30 50,60 100,30 50,0 0,30"/>\n        </symbol>\n          <symbol id="stack" viewbox="-7 -7 114 60">\n            <polyline class=\'graph\' points="0,0 50,30 100,0"/>\n          </symbol>\n          <symbol id="stackH" viewbox="-7 -7 114 60">\n          <polyline class=\'graph\' points="0,0 50,30 100,0"/>\n        </symbol>\n          '+r+"\n      </svg>\n        "+n}}const chart=document.querySelector("paper-graph");!function(t,e,a){a=a||window;var s=!1;a.addEventListener(t,(function(){s||(s=!0,requestAnimationFrame((function(){a.dispatchEvent(new CustomEvent(e)),s=!1})))}))}("resize","optimizedResize");let resizeTimer=null;window.addEventListener("optimizedResize",(function(){clearTimeout(resizeTimer),resizeTimer=setTimeout((()=>{window.matchMedia("(min-width: 900px)").matches?40!=chart.max&&(chart.max=40,chart.start()):30!=chart.max&&(chart.max=30,chart.start())}),100)}));class CountUp extends HTMLElement{constructor(){super(),this.start=null,this.i=0}static get observedAttributes(){return["value","dur"]}connectedCallback(){""!=this.value&&this.go()}attributeChangedCallback(t,e,a){this[t]=a,""!=this.value&&this.value!=e&&this.go()}go(){this.start=performance.now(),window.requestAnimationFrame(this.frame.bind(this))}frame(t){let e=t-this.start;var a;this.i=((a=e/(1e3*this.dur))>1?1:a*(2-a))*this.value,Math.ceil(this.i)<this.value&&(this.innerText=Math.ceil(this.i),window.requestAnimationFrame(this.frame.bind(this)))}}class ProBar extends HTMLElement{constructor(){super()}static get observedAttributes(){return["value"]}connectedCallback(){this.pt=null,this.fill()}attributeChangedCallback(t,e,a){this[t]=a,a!=e&&this.fill()}fill(){let t=Number(this.value.split("%")[0]).toFixed(1);if(this.querySelector("#percent").innerText=this.value,this.pt||(this.pt=t),this.pt!=t){this.pt=t;let e=`\n--bg: linear-gradient(\n  0deg,\n  var(--theme-color-light) ${this.pt}%,\n  white ${this.pt}%\n);`;this.style.cssText=e}}}customElements.define("paper-graph",PaperGraph),customElements.define("count-up",CountUp),customElements.define("pro-bar",ProBar);const toast=(t,e,a=3e3)=>{let s=document.querySelector("toast"),r=document.querySelector("toast #icon"),n=document.querySelector("toast #messages");"warning"==t?(r.innerText="priority_high",r.style.cssText="background:#e3002d"):"success"==t?(r.innerText="check",r.style.cssText="background:#1b8558"):(r.innerText="notifications",r.style.cssText="background:#e8b600"),n.innerText=e,s.classList.remove("hide"),window.setTimeout((()=>{s.classList.add("hide")}),a)},DOMLinker=(t,e,a)=>{for(let[s,r]of Object.entries(e))Object.defineProperty(t,s,{get:()=>a?document.querySelector(r)[a]:document.querySelector(r),set(t){a&&(document.querySelector(r)[a]=t)}})},AttrLinker=(t,e)=>{for(let[a,s,r]of e)Object.defineProperty(t,a,{get:()=>document.querySelector(s).getAttribute(r),set(t){document.querySelector(s).setAttribute(r,t)}})},container=document.querySelector(".container");DOMLinker(container,{writeButton:".writearea"});const letter=document.querySelector("div#letter");DOMLinker(letter,{editProfileButton:"#pfbut",exitButton:"div#letter .back"});const profile=document.querySelector("#profile");DOMLinker(profile,{saveButton:"#pfsavebut"}),container.writeButton.addEventListener("click",(t=>{t.isTrusted&&history.pushState({now:"letter"},"",location.href),rtd.stop(),mailcounter.stop(),container.classList.add("blur"),letter.classList.remove("slide"),DB.access.name&&DB.access.pw||(setTimeout((()=>{document.querySelector(".sender").classList.add("highlight")}),1e3),setTimeout((()=>{document.querySelector(".sender").classList.remove("highlight")}),3e3)),(tempLetter=forms.tempLoad())&&([forms.title,forms.body]=[tempLetter.title,tempLetter.body]),DB.access.getItem("name")&&(profileInfo.icon="person",pf={name:DB.access.name,rel:DB.access.rel,postcode:DB.access.postcode,addr1:DB.access.addr1,addr2:DB.access.addr2,addr3:DB.access.addr3,pw:DB.access.pw},profileInfo.render(pf),forms.update(pf))})),letter.editProfileButton.addEventListener("click",(t=>{t.isTrusted&&history.pushState({now:"profile"},"",location.href),letter.classList.add("blur"),profile.classList.remove("slide")})),document.querySelectorAll(".back").forEach((t=>{t.addEventListener("click",(()=>{currentPopup=t.parentElement.parentElement,currentPopup.classList.add("slide"),currentPopup.previousElementSibling.classList.remove("blur"),"container"==currentPopup.previousElementSibling.classList.value?(rtd.start(),mailcounter.start()):(document.querySelectorAll(".clsd").forEach((t=>{t.classList.remove("clsd")})),postal_wrap.style.display="none")}))})),window.onpopstate=t=>{try{"profile"==t.state.now?letter.editProfileButton.click():"letter"==t.state.now?(document.querySelector("div#profile .back").click(),letter.classList.contains("slide")&&container.writeButton.click()):"main"==t.state.now?document.querySelector("div#letter .back").click():t.state.beforeExit&&toast("","뒤로 버튼을 한번 더 누르면 종료됩니다.")}catch(t){history.back()}},window.addEventListener("load",(function(){window.history.pushState({beforeExit:!0},""),window.history.pushState({now:"main"},"")})),document.addEventListener("keyup",(t=>{"Escape"!=t.key||document.querySelector("div#letter").classList.contains("slide")||history.back()}));const postal_wrap=document.getElementById("wrap"),postalcodeSearch=()=>{document.querySelectorAll(".clsb").forEach((t=>{t.classList.add("clsd")})),new daum.Postcode({oncomplete:function(t){var e="",a="";e="R"===t.userSelectedType?t.roadAddress:t.jibunAddress,"R"===t.userSelectedType?(""!==t.bname&&/[동|로|가]$/g.test(t.bname)&&(a+=t.bname),""!==t.buildingName&&"Y"===t.apartment&&(a+=""!==a?", "+t.buildingName:t.buildingName),""!==a&&(a=" ("+a+")"),document.getElementById("extraAddress").value=a):document.getElementById("extraAddress").value="",document.getElementById("postcode").value=t.zonecode,document.getElementById("address").value=e,document.querySelectorAll(".clsd").forEach((t=>{t.classList.remove("clsd")})),document.getElementById("detailAddress").focus(),postal_wrap.style.display="none"},width:"100%",height:"100%"}).embed(postal_wrap),postal_wrap.style.display="block"};document.getElementById("postbut").addEventListener("click",postalcodeSearch);const forms={tempSave:()=>{DB.access.tempLetter=JSON.stringify({title:forms.title,body:forms.body})},tempLoad:()=>{try{return JSON.parse(DB.access.tempLetter)}catch{return!1}}};DOMLinker(forms,{name:"#namef",rel:"#relf",postcode:"#postcode",addr1:"#address",addr2:"#detailAddress",addr3:"#extraAddress",pw:"#pw",title:".ltitle input",body:".contents textarea"},"value");const profileInfo={};DOMLinker(profileInfo,{name:".info #name",rel:".info #rel",addr1:".info #addr1",addr2:".info #addr2",icon:"#pfbut"},"innerText");const DB={save:t=>{let e=localStorage;e.name=t.name,e.rel=t.rel,e.postcode=t.postcode,e.addr1=t.addr1,e.addr2=t.addr2,e.addr3=t.addr3,e.pw=""==t.pw?t.name+t.postcode:t.pw},access:localStorage};function update(t){"string"==typeof t&&(t=new Date(t));let e=(t,e)=>(e-t)/1e3/60/60/24;this.percent=Number((t-ENLIST_DAY)/(this.end-ENLIST_DAY)*100).toFixed(5)+"%";let a=Math.ceil(e(t,this.end));this.left!=a&&(this.left=Math.ceil(e(t,this.end)))}profileInfo.render=t=>{profileInfo.name=t.name,profileInfo.rel=t.rel,profileInfo.addr1=t.addr1+" "+t.addr2,profileInfo.addr2=t.addr3},forms.update=t=>{forms.name=t.name,forms.rel=t.rel,forms.postcode=t.postcode,forms.addr1=t.addr1,forms.addr2=t.addr2,forms.addr3=t.addr3,forms.pw=t.pw},document.querySelectorAll("#profile input").forEach((t=>{t.addEventListener("keyup",(t=>{"Enter"==t.key&&profile.saveButton.click()}))})),profile.saveButton.addEventListener("click",(()=>{DB.save(forms),profileInfo.render(forms),forms.pw=localStorage.pw,profile.querySelector(".back").click(),toast("success","프로필을 저장하였습니다.")}));const completion={end:COMPLETION_DAY,update:update},discharge={end:DISCHARGE_DAY,update:update};AttrLinker(completion,[["percent","pro-bar#cp","value"],["left","#cpFig","value"]]),AttrLinker(discharge,[["percent","pro-bar#dc","value"],["left","#dcFig","value"]]);let unchanged=0;const autosaver=window.setInterval((()=>{letter.classList.contains("slide")||(0==forms.tempLoad()?forms.tempSave():forms.tempLoad().body!=forms.body?(unchanged=0,forms.tempSave()):unchanged<=5&&(unchanged+=1,unchanged>5&&toast("","자동 저장되었습니다.")))}),1e3),loading=t=>{document.querySelector("loading").style.cssText=t?"display:block":""},send=()=>{let t={zipcode:forms.postcode,addr1:forms.addr1,addr2:forms.addr2+forms.addr3,name:forms.name,relationship:forms.rel,title:forms.title,contents:forms.body,password:forms.pw};""==t.name||""==t.password||""==t.zipcode?(toast("warning","프로필을 먼저 등록해주세요"),letter.editProfileButton.click()):(timeout=new Promise(((t,e)=>{loading(!0);const a=setTimeout((()=>{clearTimeout(a),e("timeout!")}),1e4)})),ajax=async()=>{const e=await fetch(API_PATH+"send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await e.json();return Number(a.result)},Promise.race([ajax(),timeout]).then((t=>{loading(!1),2==t?(letter.exitButton.click(),window.setTimeout((()=>{forms.title="",forms.body="",forms.tempSave()}),1e3),toast("success","전송되었습니다.")):-1==t?toast("warning","공군 서버 응답없음- 다시 시도해주세요!"):-2==t?toast("warning","전송 과정 오류 - 다시 시도해주세요!"):-99==t&&toast("warning","개발중입니다.")})).catch((t=>{loading(!1),toast("warning","API 서버 응답없음- 다시 시도해주세요!")})))};document.querySelectorAll("#send").forEach((t=>{t.addEventListener("click",send)})),"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("service-worker-min.js").then((t=>{})).catch((t=>{}))})),window.addEventListener("beforeinstallprompt",(t=>{t.preventDefault(),deferredPrompt=t,addBtn=document.querySelector("#install"),addBtn.style.display="inline",addBtn.addEventListener("click",(t=>{addBtn.style.display="none",deferredPrompt.prompt(),deferredPrompt.userChoice.then((t=>{t.outcome,deferredPrompt=null}))}))}));const rtd=new Animator(100);rtd.register((()=>{now=new Date,completion.update(now),discharge.update(now)})),rtd.start();const getDBCount=()=>{now=new Date,chart.update(DB.access.total||0)},getCount=()=>{ajax=async t=>{const e=await fetch(API_PATH+"count",t?{method:"POST"}:{});return await e.json()},ajax().then((t=>{chart.update(t.today,t.total),DB.access.today=t.today,DB.access.total=t.total,DB.access.cachedate=(new Date).getDate(),new Date-new Date(t["update-time"])>6e4&&ajax(!0).then((t=>{1==t.result?(chart.update(t.today,t.total),DB.access.today=t.today,DB.access.total=t.total):(clearInterval(rtn),chart.error(),toast("warning","편지수를 받아올 수 없습니다."))}))}))};class Counter{constructor(t){this.interval=null,this.throttle=t||10}register(t){this.f=t}start(){this.f(),this.interval=setInterval(this.f,1e3*this.throttle)}stop(){clearInterval(this.interval)}}now=new Date,chart.update(DB.access.total||0);const mailcounter=new Counter(10);mailcounter.register((()=>{ajax=async t=>{const e=await fetch(API_PATH+"count",t?{method:"POST"}:{});return await e.json()},ajax().then((t=>{chart.update(t.today,t.total),DB.access.today=t.today,DB.access.total=t.total,DB.access.cachedate=(new Date).getDate(),new Date-new Date(t["update-time"])>6e4&&ajax(!0).then((t=>{1==t.result?(chart.update(t.today,t.total),DB.access.today=t.today,DB.access.total=t.total):(clearInterval(rtn),chart.error(),toast("warning","편지수를 받아올 수 없습니다."))}))}))})),mailcounter.start();